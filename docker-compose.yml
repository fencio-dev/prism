version: '3.9'

networks:
  guard-network:
    driver: bridge

volumes:
  hitlogs:
    driver: local
  chromadb-data:
    driver: local
  logs:
    driver: local
  model-cache:
    driver: local

services:
  chromadb:
    image: chromadb/chroma:latest
    container_name: guard-chromadb
    ports:
      - "0.0.0.0:${CHROMA_PORT:-8000}:8000"
    volumes:
      - chromadb-data:/chroma/data
    networks:
      - guard-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8000"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    environment:
      - IS_PERSISTENT=TRUE

  data-plane:
    build:
      context: .
      dockerfile: Dockerfile.data-plane
    container_name: guard-data-plane
    ports:
      - "0.0.0.0:${DATA_PLANE_PORT:-50051}:50051"
    volumes:
      - hitlogs:/var/hitlogs
      - logs:/app/data/logs
    networks:
      - guard-network
    depends_on:
      chromadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nc", "-z", "data-plane", "50051"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - MANAGEMENT_PLANE_URL=http://management-plane:8001/api/v2
      - CHROMA_URL=http://chromadb:8000

  management-plane:
    build:
      context: .
      dockerfile: Dockerfile.management-plane
    container_name: guard-management-plane
    ports:
      - "0.0.0.0:${MGMT_PLANE_PORT:-8001}:8001"
    volumes:
      - logs:/app/data/logs
      - model-cache:/root/.cache/huggingface
      - ./management_plane/models:/app/management_plane/models:ro
    networks:
      - guard-network
    depends_on:
      data-plane:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://management-plane:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - MGMT_PLANE_PORT=${MGMT_PLANE_PORT:-8001}
      - DATA_PLANE_URL=grpc://data-plane:50051
      - CHROMA_URL=http://chromadb:8000
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///./guard.db}
      - CANONICALIZATION_ENABLED=${CANONICALIZATION_ENABLED:-true}
      - BERT_MODEL_PATH=${BERT_MODEL_PATH:-/app/management_plane/models/bert}
      - BERT_TOKENIZER_PATH=${BERT_TOKENIZER_PATH:-/app/management_plane/models/bert}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-1.5-flash}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}

  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile.mcp-server
    container_name: guard-mcp-server
    ports:
      - "0.0.0.0:${MCP_SERVER_PORT:-3001}:3001"
    volumes:
      - logs:/app/data/logs
    networks:
      - guard-network
    depends_on:
      management-plane:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-s", "-H", "Accept: text/event-stream", "http://mcp-server:3001/mcp"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    environment:
      - MANAGEMENT_PLANE_URL=http://management-plane:8001
      - MCP_SERVER_PORT=${MCP_SERVER_PORT:-3001}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
